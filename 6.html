<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>åº”æ€¥é¿éš¾åœºæ‰€é€‰å€åˆ†æç³»ç»Ÿ</title>

  <!-- é«˜å¾·åœ°å›¾ JS API v2.0 -->
  <script src="https://webapi.amap.com/maps?v=2.0&key=8f7eebbf94925cd6fd5f61e457db7c4d"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #map { width: 100%; height: 100%; overflow: hidden; }
    #controls {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      max-width: 320px;
      z-index: 1000;
      font-family: "Microsoft YaHei", sans-serif;
      font-size: 14px;
    }
    #controls h3 {
      margin-bottom: 10px;
      font-size: 16px;
    }
    #controls label,
    #controls button,
    #controls select,
    #controls p {
      display: block;
      margin: 8px 0;
    }
    #statsChartContainer {
      margin-top: 15px;
    }
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="controls">
    <h3>åº”æ€¥é¿éš¾åœºæ‰€é€‰å€åˆ†æç³»ç»Ÿ</h3>
    <label><input type="checkbox" id="geojsonToggle" checked /> æ˜¾ç¤ºé¿éš¾æ‰€+è¡Œæ”¿åŒº</label><br>
    <button id="locateBtn">ğŸ“ å®šä½åˆ°æˆ‘</button><br>
    <label>å‘¨è¾¹æœç´¢åŠå¾„ï¼ˆç±³ï¼‰ï¼š</label>
    <select id="radiusSelect">
      <option value="500">500</option>
      <option value="1000" selected>1000</option>
      <option value="2000">2000</option>
    </select>
    <p>ğŸ‘‰ ç‚¹å‡»åœ°å›¾ä»»æ„ä½ç½®ï¼Œæœç´¢è¯¥ç‚¹å‘¨è¾¹é¿éš¾æ‰€</p>
    <div id="statsChartContainer">
      <canvas id="districtChart" height="200"></canvas>
    </div>
  </div>

  <script>
    // === æ¨¡æ‹Ÿé¿éš¾æ‰€æ•°æ®ï¼ˆç‚¹ï¼‰===
    const shelters = [
      { name: "äººæ°‘å…¬å›­åº”æ€¥é¿éš¾æ‰€", lng: 116.403, lat: 39.915, district: "ä¸œåŸåŒº", capacity: 500 },
      { name: "æœé˜³ä½“è‚²ä¸­å¿ƒ", lng: 116.485, lat: 39.922, district: "æœé˜³åŒº", capacity: 1200 },
      { name: "æµ·æ·€å®éªŒä¸­å­¦æ“åœº", lng: 116.302, lat: 39.952, district: "æµ·æ·€åŒº", capacity: 800 },
      { name: "ä¸°å°æ–‡åŒ–å¹¿åœº", lng: 116.282, lat: 39.852, district: "ä¸°å°åŒº", capacity: 600 },
      { name: "çŸ³æ™¯å±±å¸‚æ°‘åº”æ€¥ä¸­å¿ƒ", lng: 116.205, lat: 39.905, district: "çŸ³æ™¯å±±åŒº", capacity: 700 },
      { name: "è¥¿åŸé˜²ç¾å…¬å›­", lng: 116.352, lat: 39.912, district: "è¥¿åŸåŒº", capacity: 900 },
      { name: "é€šå·è¿æ²³å¹¿åœº", lng: 116.660, lat: 39.902, district: "é€šå·åŒº", capacity: 1000 }
    ];

    // === æ¨¡æ‹Ÿè¡Œæ”¿åŒºè¾¹ç•Œï¼ˆç®€åŒ–å¤šè¾¹å½¢ï¼‰===
    const districts = [
      {
        name: "ä¸œåŸåŒº",
        path: [
          [116.39, 39.90], [116.42, 39.90], [116.42, 39.93], [116.39, 39.93], [116.39, 39.90]
        ]
      },
      {
        name: "æœé˜³åŒº",
        path: [
          [116.45, 39.90], [116.50, 39.90], [116.50, 39.95], [116.45, 39.95], [116.45, 39.90]
        ]
      },
      {
        name: "æµ·æ·€åŒº",
        path: [
          [116.25, 39.93], [116.32, 39.93], [116.32, 39.98], [116.25, 39.98], [116.25, 39.93]
        ]
      }
      // å¯ç»§ç»­æ·»åŠ å…¶ä»–åŒº
    ];

    let map;
    let shelterMarkers = [];
    let districtOverlays = [];

    function initMap() {
      map = new AMap.Map('map', {
        zoom: 11,
        center: [116.4, 39.9],
        viewMode: '2D'
      });

      // âœ… æ­£ç¡®åŠ è½½æ§ä»¶
      map.plugin(['AMap.Scale', 'AMap.ToolBar'], function () {
        map.addControl(new AMap.Scale({ visible: true }));
        map.addControl(new AMap.ToolBar({ visible: true }));
      });

      // åŠ è½½ GeoJSON æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰
      loadGeoJSONLayers();

      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      map.on('click', onMapClick);

      // æ¸²æŸ“ç»Ÿè®¡å›¾
      renderDistrictChart();

      // æ§ä»¶äº¤äº’
      document.getElementById('geojsonToggle').addEventListener('change', function () {
        const show = this.checked;
        shelterMarkers.forEach(m => m.setMap(show ? map : null));
        districtOverlays.forEach(o => o.setMap(show ? map : null));
      });

      // å®šä½æŒ‰é’®
      document.getElementById('locateBtn').addEventListener('click', function () {
        if (!navigator.geolocation) {
          alert('æµè§ˆå™¨ä¸æ”¯æŒå®šä½');
          return;
        }
        map.plugin('AMap.Geolocation', function () {
          const geolocation = new AMap.Geolocation({ enableHighAccuracy: true, timeout: 10000 });
          geolocation.getCurrentPosition((status, result) => {
            if (status === 'complete') {
              map.setCenter(result.position);
              map.setZoom(14);
            } else {
              alert('å®šä½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚');
            }
          });
        });
      });
    }

    function loadGeoJSONLayers() {
      // æ·»åŠ é¿éš¾æ‰€ç‚¹
      shelters.forEach(shelter => {
        const marker = new AMap.Marker({
          position: [shelter.lng, shelter.lat],
          title: shelter.name,
          map: map,
          zIndex: 100
        });
        shelterMarkers.push(marker);
      });

      // æ·»åŠ è¡Œæ”¿åŒºé¢
      districts.forEach(district => {
        const polygon = new AMap.Polygon({
          path: district.path,
          strokeColor: "#FF33FF",
          strokeWeight: 2,
          fillColor: "#FFCCFF",
          fillOpacity: 0.3,
          map: map
        });
        districtOverlays.push(polygon);
      });
    }

    function onMapClick(e) {
      const radius = parseInt(document.getElementById('radiusSelect').value);
      const clickPoint = e.lnglat;

      // ç§»é™¤æ—§åœ†åœˆ
      if (window.searchCircle) map.remove(window.searchCircle);
      window.searchCircle = new AMap.Circle({
        center: clickPoint,
        radius: radius,
        strokeColor: "#FF6600",
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: "#FFCC99",
        fillOpacity: 0.3
      });
      window.searchCircle.setMap(map);

      // æŸ¥æ‰¾é™„è¿‘é¿éš¾æ‰€
      const nearby = shelters.filter(s => {
        const dist = AMap.GeometryUtil.distance(clickPoint, [s.lng, s.lat]);
        return dist <= radius;
      });

      let content = `<b>ğŸ“ ${radius}ç±³èŒƒå›´å†…æ‰¾åˆ° ${nearby.length} ä¸ªé¿éš¾æ‰€ï¼š</b><br>`;
      if (nearby.length === 0) {
        content += "âš ï¸ è¯¥åŒºåŸŸæš‚æ— åº”æ€¥é¿éš¾åœºæ‰€";
      } else {
        nearby.forEach(s => {
          content += `â€¢ ${s.name}ï¼ˆ${s.district}ï¼Œå®¹é‡ï¼š${s.capacity}äººï¼‰<br>`;
        });
      }

      new AMap.InfoWindow({ content, offset: new AMap.Pixel(0, -10) }).open(map, clickPoint);
    }

    function renderDistrictChart() {
      const districtCount = {};
      shelters.forEach(s => {
        districtCount[s.district] = (districtCount[s.district] || 0) + 1;
      });

      const ctx = document.getElementById('districtChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(districtCount),
          datasets: [{
            label: 'é¿éš¾æ‰€æ•°é‡',
            data: Object.values(districtCount),
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
      });
    }

    window.addEventListener('load', initMap);
  </script>
</body>
</html>